# main.py - Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙŠ Replit
import streamlit as st
import os
from blackbox_client import BlackboxAIClient
import subprocess
import tempfile

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø©
st.set_page_config(
    page_title="ğŸ”¥ BlackboxAI + Replit Integration",
    page_icon="ğŸ”¥",
    layout="wide"
)

# ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„
@st.cache_resource
def init_blackbox_client():
    return BlackboxAIClient()

client = init_blackbox_client()

st.title("ğŸ”¥ BlackboxAI Ù…Ø¹ Replit - Ù…ÙˆÙ„Ø¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠ")

# Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
with st.sidebar:
    st.header("âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")
    
    language = st.selectbox(
        "Ù„ØºØ© Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©:",
        ["python", "javascript", "java", "cpp", "html", "css", "sql"]
    )
    
    complexity = st.slider("Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù‚ÙŠØ¯:", 1, 5, 3)
    
    include_comments = st.checkbox("ØªØ¶Ù…ÙŠÙ† Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª", True)

# Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
col1, col2 = st.columns([1, 1])

with col1:
    st.header("ğŸ“ ÙˆØµÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")
    
    user_prompt = st.text_area(
        "Ø§ÙƒØªØ¨ ÙˆØµÙ Ù„Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:",
        height=200,
        placeholder="Ù…Ø«Ø§Ù„: Ø§ÙƒØªØ¨ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ø­ØªÙ‰ Ø±Ù‚Ù… Ù…Ø¹ÙŠÙ†"
    )
    
    if st.button("ğŸš€ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯", type="primary"):
        if user_prompt:
            with st.spinner("Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯..."):
                try:
                    # ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨
                    enhanced_prompt = f"""
                    Create a {language} program that {user_prompt}.
                    Requirements:
                    - Complexity level: {complexity}/5
                    - Include comments: {include_comments}
                    - Make it production-ready
                    - Add error handling
                    """
                    
                    generated_code = client.generate_code(enhanced_prompt, language)
                    st.session_state.generated_code = generated_code
                    st.session_state.current_language = language
                    
                except Exception as e:
                    st.error(f"Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯: {str(e)}")

with col2:
    st.header("ğŸ’» Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆÙ„Ø¯")
    
    if 'generated_code' in st.session_state:
        # Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ¯
        st.code(st.session_state.generated_code, language=st.session_state.current_language)
        
        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
        col2_1, col2_2, col2_3 = st.columns(3)
        
        with col2_1:
            if st.button("â–¶ï¸ ØªØ´ØºÙŠÙ„"):
                if st.session_state.current_language == "python":
                    try:
                        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…Ø¤Ù‚Øª ÙˆØªØ´ØºÙŠÙ„Ù‡
                        with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
                            f.write(st.session_state.generated_code)
                            temp_file = f.name
                        
                        result = subprocess.run(['python', temp_file], 
                                              capture_output=True, text=True, timeout=10)
                        
                        if result.stdout:
                            st.success("âœ… ØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!")
                            st.text("Ø§Ù„Ù†ØªÙŠØ¬Ø©:")
                            st.code(result.stdout)
                        
                        if result.stderr:
                            st.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„:")
                            st.code(result.stderr)
                            
                        os.unlink(temp_file)
                        
                    except Exception as e:
                        st.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„: {str(e)}")
        
        with col2_2:
            if st.button("ğŸ“‹ Ù†Ø³Ø®"):
                st.write("ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯!")
                # ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© JavaScript Ù„Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ ÙØ¹Ù„ÙŠØ§Ù‹
        
        with col2_3:
            if st.button("ğŸ’¾ Ø­ÙØ¸"):
                filename = f"generated_code.{st.session_state.current_language}"
                with open(filename, 'w') as f:
                    f.write(st.session_state.generated_code)
                st.success(f"ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ {filename}")

# Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ø´Ø±Ø­
if 'generated_code' in st.session_state:
    st.header("ğŸ” ØªØ­Ù„ÙŠÙ„ ÙˆØ´Ø±Ø­ Ø§Ù„ÙƒÙˆØ¯")
    
    if st.button("Ø´Ø±Ø­ Ø§Ù„ÙƒÙˆØ¯"):
        with st.spinner("Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯..."):
            try:
                explanation = client.explain_code(st.session_state.generated_code)
                st.write(explanation)
            except Exception as e:
                st.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø±Ø­: {str(e)}")

# Ù‚Ø³Ù… Ø§Ù„ØªØ­Ø³ÙŠÙ†
st.header("âš¡ ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙƒÙˆØ¯")

optimization_type = st.selectbox(
    "Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†:",
    ["Ø§Ù„Ø£Ø¯Ø§Ø¡", "Ø§Ù„Ø£Ù…Ø§Ù†", "Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©", "Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø°Ø§ÙƒØ±Ø©"]
)

if st.button("ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙƒÙˆØ¯") and 'generated_code' in st.session_state:
    with st.spinner("Ø¬Ø§Ø±ÙŠ ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙƒÙˆØ¯..."):
        try:
            optimization_prompt = f"""
            Optimize this {st.session_state.current_language} code for {optimization_type}:
            
            {st.session_state.generated_code}
            
            Provide the optimized version with explanations of changes made.
            """
            
            optimized_code = client.generate_code(optimization_prompt, st.session_state.current_language)
            
            st.subheader("Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø³Ù†:")
            st.code(optimized_code, language=st.session_state.current_language)
            
        except Exception as e:
            st.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø³ÙŠÙ†: {str(e)}")
